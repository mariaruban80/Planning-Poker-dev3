<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Planning Poker Interactive</title>
<style>
    /* Existing CSS styles preserved - not changing UI */
    body { 
      background: white;
      font-family: 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
      line-height: 1.5;
      color: #333;
      margin: 0;
      padding: 0;
    }
    /* All other existing styles remain unchanged */
    /* ... your existing styles ... */
</style>
</head>
<body>

    <header>
  <div class="logo">
    <img src="spade.png" alt="Planning Poker" />
    <span>Planning Poker</span>
  </div>
  <div class="nav-links">    
    <button id="logOffBtn" class="btn btn-danger join-session">LOG OFF</button>   
  </div>
</header>

<!-- Create a completely new custom invite modal that doesn't use the same ID or classes as the original -->
<div id="inviteModalCustom">
<div class="modal-content">
<h3>Invite Link</h3>
<input id="inviteLinkCustom" readonly="" type="text"/>
<div class="button-group">
<button onclick="copyInviteLinkCustom()">Copy Link</button>
<button onclick="hideInviteModalCustom()">Close</button>
</div>
</div>
</div>

<!-- Custom Login Modal -->
<div id="loginModalCustom" style="display: none;">
  <div class="modal-content">
    <h3>Join Planning Poker Session</h3>
    <p>Please enter your name to join the session</p>
    <input id="userNameInput" type="text" placeholder="Your name" />
    <div class="button-group">
      <button id="joinSessionWithName" class="action-button">Join Session</button>
    </div>
  </div>
</div>    

<!-- Custom Add Ticket Modal -->
<div id="addTicketModalCustom" style="display: none;">
  <div class="modal-content add-ticket-modal">
    <h3>Add New Ticket</h3>
    
    <div class="input-group">
      <label for="ticketNameInput">Name</label>
      <input id="ticketNameInput" type="text" placeholder="Enter ticket name">
    </div>
    
    <div class="input-group">
      <label for="ticketDescriptionInput">Description</label>
      <input id="ticketDescriptionInput" type="text" placeholder="Enter ticket description">
    </div>
    
    <div class="button-group">
      <button id="cancelAddTicket" class="cancel-button">CANCEL</button>
      <button id="confirmAddTicket" class="confirm-button">
        <span class="plus-icon">+</span> ADD
      </button>
    </div>
  </div>
</div>    

<!-- Updated Upload Section - moved to right side as per screenshot -->
<div class="upload-section">
<div class="upload-right">
<div class="file-input" id="fileInputContainer">
<span class="file-button">Upload Ticket</span>
<input accept=".csv" id="csvInput" type="file"/>
</div>
<button class="invite-button" id="inviteButton">Invite Others</button>
</div>
</div>

<div class="container">
<div class="sidebar">
<h3>Current Members</h3>
<div id="userList"></div>
<h3 class="section-heading">Voting Controls</h3>
<!-- Added controls-section for better styling of control buttons -->
<div class="controls-section">
<button class="button" id="revealVotesBtn">Reveal Votes</button>
<button class="button" id="resetVotesBtn">Reset Votes</button>
<!-- <button class="button" id="exportCsvBtn">Export All Votes</button> -->
</div>
</div>
<div class="main">
<!-- Story will be displayed in the poker-table-layout instead of here -->
<!-- New poker table layout will be rendered here -->
<div class="user-circle-container" id="userCircle"></div>
<!-- Simple no stories message -->
<div class="no-stories-message" id="noStoriesMessage">
        No stories available. Please upload or add stories to start voting.
      </div>
<!-- Planning cards -->
<div class="planning-cards-section">
<h3>Planning Cards</h3>
<div class="cards" id="planningCards">
<div class="card" data-value="0" draggable="true">0</div>
<div class="card" data-value="1" draggable="true">1</div>
<div class="card" data-value="3" draggable="true">3</div>
<div class="card" data-value="5" draggable="true">5</div>
<div class="card" data-value="8" draggable="true">8</div>
<div class="card" data-value="13" draggable="true">13</div>
<div class="card" data-value="21" draggable="true">21</div>
</div>
</div>
</div>
<div class="rightbar" id="storyListContainer">
<!-- Added ID to the ADD TICKET button -->
<button class="add-ticket-btn" id="addTicketBtn"><span>+</span>ADD TICKET</button>
<!-- The story list CONTAINER with no hardcoded stories -->
<div class="story-container" id="storyList">
<!-- Stories will be loaded dynamically -->
</div>
<!-- Navigation buttons -->
<div class="navigation-buttons">
<button class="button" id="prevStory">Previous Story</button>
<button class="button" id="nextStory">Next Story</button>
</div>
</div>
</div>

<!-- Scripts -->
<script src="main.js" type="module"></script>
<script>
    // Function to check if there are any stories and update UI accordingly
    function checkForStories() {
      const storyList = document.getElementById('storyList');
      const noStoriesMessage = document.getElementById('noStoriesMessage');
      const planningCards = document.querySelectorAll('#planningCards .card');
      
      // Check if there are any story cards
      const storyCards = storyList ? storyList.querySelectorAll('.story-card') : [];
      const hasStories = storyCards.length > 0;
      
      if (!hasStories) {
        // No stories - disable planning cards
        planningCards.forEach(card => {
          card.classList.add('disabled');
          card.setAttribute('draggable', 'false');
        });
        
        // Show no stories message
        if (noStoriesMessage) {
          noStoriesMessage.style.display = 'block';
        }
      } else {
        // Has stories - enable planning cards
        planningCards.forEach(card => {
          card.classList.remove('disabled');
          card.setAttribute('draggable', 'true');
        });
        
        // Hide no stories message
        if (noStoriesMessage) {
          noStoriesMessage.style.display = 'none';
        }
      }
    }
    
    // Function to remove or hide any modals from the original app
    function hideAllOriginalModals() {
      // Find and hide all modal dialogs from the original app
      const modalDialogs = document.querySelectorAll('.modal-dialog, .modal-overlay');
      modalDialogs.forEach(modal => {
        modal.style.display = 'none';
        modal.style.visibility = 'hidden';
        modal.style.opacity = '0';
        modal.style.pointerEvents = 'none';
      });
    }
      
    // Add Ticket Modal Functions
    function showAddTicketModal() {
      // Clear previous input values
      document.getElementById('ticketNameInput').value = '';
      document.getElementById('ticketDescriptionInput').value = '';
      
      // Show the modal
      document.getElementById('addTicketModalCustom').style.display = 'flex';
      
      // Focus on the name input
      setTimeout(() => {
        document.getElementById('ticketNameInput').focus();
      }, 100);
    }

    function hideAddTicketModal() {
      document.getElementById('addTicketModalCustom').style.display = 'none';
    }

    function handleAddTicketSubmit() {
      const ticketName = document.getElementById('ticketNameInput').value.trim();
      const ticketDescription = document.getElementById('ticketDescriptionInput').value.trim();
      
      // Validate input
      if (!ticketName) {
        const nameInput = document.getElementById('ticketNameInput');
        nameInput.classList.add('shake');
        nameInput.style.borderColor = '#ff4d4f';
        
        setTimeout(() => {
          nameInput.classList.remove('shake');
        }, 500);
        
        return;
      }
      
      // Prepare ticket text (combine name and description if provided)
      let ticketText = ticketName;
      if (ticketDescription) {
        ticketText = ticketName + ': ' + ticketDescription;
      }
      
      // Create ticket data
      const ticketData = {
        id: `story_${Date.now()}`,
        text: ticketText
      };
      
      // Hide the modal
      hideAddTicketModal();
      
      // If we have access to main.js functions
      if (window.addTicketFromModal) {
        window.addTicketFromModal(ticketData);
      } else {
        // Fallback implementation
        const storyList = document.getElementById('storyList');
        
        if (storyList) {
          const storyCard = document.createElement('div');
          storyCard.className = 'story-card';
          storyCard.id = ticketData.id;
          
          const storyTitle = document.createElement('div');
          storyTitle.className = 'story-title';
          storyTitle.textContent = ticketData.text;
          
          storyCard.appendChild(storyTitle);
          storyList.appendChild(storyCard);
          
          // Try to emit to socket if available
          if (window.socket) {
            window.socket.emit('addTicket', ticketData);
          }
        }
      }
    }

    // Set up event listeners for the add ticket modal
    document.addEventListener('DOMContentLoaded', function() {
      // Set up Add Ticket button to use modal
      const addTicketBtn = document.getElementById('addTicketBtn');
      if (addTicketBtn) {
        // Remove any existing click handlers by cloning the button
        const newBtn = addTicketBtn.cloneNode(true);
        addTicketBtn.parentNode.replaceChild(newBtn, addTicketBtn);
        
        // Add new click handler for the modal
        newBtn.addEventListener('click', showAddTicketModal);
      }
      
      // Set up modal buttons
      document.getElementById('cancelAddTicket').addEventListener('click', hideAddTicketModal);
      document.getElementById('confirmAddTicket').addEventListener('click', handleAddTicketSubmit);
      
      // Set up enter key in description field
      document.getElementById('ticketDescriptionInput').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          handleAddTicketSubmit();
        }
      });
    });

    // Expose function for main.js
    window.showAddTicketModal = showAddTicketModal;
    
    function isGuestUser() {
      // Check if URL contains 'roomId' parameter but not 'host=true'
      const urlParams = new URLSearchParams(window.location.search);
      
      // Consider user a guest if:
      // 1. There's no 'host' parameter, or
      // 2. The 'host' parameter is anything other than 'true'
      return urlParams.has('roomId') && (!urlParams.has('host') || urlParams.get('host') !== 'true');
    }

    function setupGuestModeOnLoad() {
      if (isGuestUser()) {
        console.log('Guest mode activated - hiding control elements');
        
        // Hide control buttons in sidebar
        const revealVotesBtn = document.getElementById('revealVotesBtn');
        const resetVotesBtn = document.getElementById('resetVotesBtn');
        if (revealVotesBtn) revealVotesBtn.classList.add('hide-for-guests');
        if (resetVotesBtn) resetVotesBtn.classList.add('hide-for-guests');
        
        // Hide upload ticket button
        const fileInputContainer = document.getElementById('fileInputContainer');
        if (fileInputContainer) fileInputContainer.classList.add('hide-for-guests');
        
        // Hide add ticket button 
        const addTicketBtn = document.getElementById('addTicketBtn');
        if (addTicketBtn) addTicketBtn.classList.add('hide-for-guests');
        
        // Add guest mode indicator if not already present
        if (!document.getElementById('guestModeIndicator')) {
          const header = document.querySelector('header');
          if (header) {
            const indicator = document.createElement('div');
            indicator.id = 'guestModeIndicator';
            indicator.style.marginLeft = 'auto';
            indicator.style.marginRight = '15px';
            indicator.style.color = '#673ab7';
            indicator.style.fontSize = '14px';
            indicator.style.fontWeight = '500';
            indicator.textContent = 'Guest Mode';
            
            // Insert before the LOG OFF button
            const logOffBtn = document.getElementById('logOffBtn');
            if (logOffBtn) {
              header.insertBefore(indicator, logOffBtn);
            } else {
              header.appendChild(indicator);
            }
          }
        }
      }
    }

    // Custom modal functions
    function showInviteModalCustom() {
      // First hide any existing modals from the original app
      hideAllOriginalModals();
      // Create a guest URL
      const currentUrl = new URL(window.location.href);
      const params = new URLSearchParams(currentUrl.search);
      const roomId = params.get('roomId');
      // Create clean guest URL (without host parameter)
      const guestUrl = `${currentUrl.origin}${currentUrl.pathname}?roomId=${roomId}`;
      // Set the link value
      document.getElementById('inviteLinkCustom').value = guestUrl;
      
      // Show our custom modal
      const modalElement = document.getElementById('inviteModalCustom');
      if (modalElement) {
        modalElement.style.display = 'flex';
      } else {
        console.error('Modal element not found!');
        // Fallback to alert if modal element is missing
        alert(`Share this invite link: ${guestUrl}`);
      }
    }

    function hideInviteModalCustom() {
      document.getElementById('inviteModalCustom').style.display = 'none';
    }

    function copyInviteLinkCustom() {
      const inviteInput = document.getElementById('inviteLinkCustom');
      inviteInput.select();
      document.execCommand('copy');
      alert('Invite link copied!');
    }
    
    // Simple function to reveal votes - only toggles the body class
    function revealVotes() {
      document.body.classList.add('votes-revealed');
    }

    // ENHANCED SCRIPT FOR USERNAME HANDLING -->
    // Global flag to track if username is ready
    window.userNameReady = false;
    
    // Define initializeAppWithName first to ensure it's available
    function initializeAppWithName(username) {
      if (!username) {
        console.error('[APP] Cannot initialize: missing username');
        return;
      }
      
      // Initialize socket connection with the username
      const urlParams = new URLSearchParams(window.location.search);
      const roomId = urlParams.get('roomId');
      if (!roomId) {
        console.error('[APP] Cannot initialize: missing roomId in URL parameters');
        return;
      }
      
      console.log(`[APP] Initializing app with username=${username}, roomId=${roomId}`);
      
      if (typeof window.initializeSocketWithName === 'function') {
        console.log('[APP] Found initializeSocketWithName function, calling it...');
        window.initializeSocketWithName(roomId, username);
      } else {
        console.error('[APP] initializeSocketWithName function not available');
        
        // Check if main.js is loaded
        if (typeof initializeWebSocket === 'undefined') {
          console.error('[APP] initializeWebSocket is not defined - main.js might not be loaded yet');
          
          // Wait a bit and try again
          setTimeout(() => {
            if (typeof window.initializeSocketWithName === 'function') {
              console.log('[APP] Found initializeSocketWithName function after delay, calling it...');
              window.initializeSocketWithName(roomId, username);
            } else {
              // Last resort - reload page
              console.log('[APP] Still cannot find initialization function, reloading page');
              window.location.reload();
            }
          }, 1000);
        } else {
          // Fallback to reloading
          window.location.reload();
        }
      }
    }
    
    // Handle username synchronization and prompt for invited users
    document.addEventListener('DOMContentLoaded', function() {
      // STEP 1: Check for username from main.html (userName with capital N)
      const storedUserName = sessionStorage.getItem('userName');
      
      // STEP 2: Check if this is a new user joining via invite link
      const urlParams = new URLSearchParams(window.location.search);
      const isJoiningViaInvite = urlParams.has('roomId') && !storedUserName;
      
      if (isJoiningViaInvite) {
        // This is someone joining via invite link who doesn't have a userName yet
        showLoginModal();
        
        // Important: Mark username as not ready to prevent socket connection
        window.userNameReady = false;
        
        // Hide main content until user provides name
        hideMainContent();
      } else {
        // User already has a name, mark as ready
        window.userNameReady = true;
      }
      
      // Debugging info
      console.log('Username from sessionStorage:', sessionStorage.getItem('userName'));
    });
    
    // Function to hide main content until user provides name
    function hideMainContent() {
      const container = document.querySelector('.container');
      const uploadSection = document.querySelector('.upload-section');
      
      if (container) container.style.display = 'none';
      if (uploadSection) uploadSection.style.display = 'none';
    }
    
    // Function to show main content after user provides name
    function showMainContent() {
      const container = document.querySelector('.container');
      const uploadSection = document.querySelector('.upload-section');
      
      if (container) container.style.display = 'flex';
      if (uploadSection) uploadSection.style.display = 'flex';
    }
    
    // Function to show custom login modal
    function showLoginModal() {
      const loginModal = document.getElementById('loginModalCustom');
      if (loginModal) {
        // Mark username as explicitly not ready to prevent socket connection
        window.userNameReady = false;
        loginModal.style.display = 'flex';
        
        // Focus on the input field
        setTimeout(() => {
          document.getElementById('userNameInput').focus();
        }, 100);
        
        // Add event listener to join button
        document.getElementById('joinSessionWithName').addEventListener('click', handleLoginSubmit);
        
        // Add event listener for enter key
        document.getElementById('userNameInput').addEventListener('keypress', function(e) {
          if (e.key === 'Enter') {
            handleLoginSubmit();
          }
        });
      } else {
        // Fallback to prompt if modal doesn't exist
        fallbackToPrompt();
      }
    }
    
    // Function to handle login form submission
    function handleLoginSubmit() {
      const username = document.getElementById('userNameInput').value.trim();
      
      if (username) {
        // Debug the username
        console.log('[LOGIN] User entered name:', username);
        
        // Store with both key formats for compatibility
        sessionStorage.setItem('userName', username);
        console.log(`User joined as: ${username}`);
        
        // Hide the modal
        document.getElementById('loginModalCustom').style.display = 'none';
        
        // Mark username as ready
        window.userNameReady = true;
        
        // Show main content
        showMainContent();
        
        // Initialize the app now that we have a username
        initializeAppWithName(username);
      } else {
        // Show validation error - shake the input
        const input = document.getElementById('userNameInput');
        input.style.borderColor = '#ff4d4f';
        input.classList.add('shake');
        
        setTimeout(() => {
          input.classList.remove('shake');
        }, 500);
      }
    }
    
    // Fallback to browser prompt if modal doesn't exist
    function fallbackToPrompt() {
      const username = prompt('Please enter your name to join the planning poker session:');
      
      if (username && username.trim()) {
        // Store with both key formats for compatibility
        sessionStorage.setItem('userName', username.trim());
        console.log(`User joined as: ${username.trim()}`);
        
        // Mark username as ready
        window.userNameReady = true;
        
        // Show main content and initialize
        showMainContent();
        initializeAppWithName(username.trim());
      } else {
        // If no username provided, set a default
        const guestName = 'Guest ' + Math.floor(Math.random() * 1000);
        sessionStorage.setItem('userName', guestName);
        alert(`You will join as "${guestName}"`);
        
        // Mark username as ready
        window.userNameReady = true;
        
        // Show main content and initialize
        showMainContent();
        initializeAppWithName(guestName);
      }
    }
    
    // Make getUserName function available globally for socket.js
    window.getUserName = function() {
      return sessionStorage.getItem('userName') || 'Anonymous';
    };

    // Log off button functionality
    document.addEventListener('DOMContentLoaded', function() {
      // Check if the button exists before trying to use it
      const logOffBtn = document.getElementById('logOffBtn');
      
      if (logOffBtn) {
        logOffBtn.addEventListener('click', function() {
          // Clear session storage
          sessionStorage.clear();
          
          // Redirect to main.html
          window.location.href = 'main.html';
        });
      } else {
        console.error('Log Off button not found - make sure the button exists in HTML');
      }
    });
    
    // Expose modal functions to window scope for main.js to use
    window.showInviteModalCustom = function() {
      // First hide any existing modals from the original app
      if (typeof hideAllOriginalModals === 'function') {
        hideAllOriginalModals();
      }
      
      // Create a guest URL
      const currentUrl = new URL(window.location.href);
      const params = new URLSearchParams(currentUrl.search);
      const roomId = params.get('roomId');
      
      // Create clean guest URL (without host parameter)
      const guestUrl = `${currentUrl.origin}${currentUrl.pathname}?roomId=${roomId}`;
      
      // Set the link value
      document.getElementById('inviteLinkCustom').value = guestUrl;
      
      // Show our custom modal
      document.getElementById('inviteModalCustom').style.display = 'flex';
    };
    
    window.hideInviteModalCustom = function() {
      document.getElementById('inviteModalCustom').style.display = 'none';
    };
    
    window.copyInviteLinkCustom = function() {
      const inviteInput = document.getElementById('inviteLinkCustom');
      inviteInput.select();
      document.execCommand('copy');
      alert('Invite link copied!');
    };
    
    // Diagnostic function to check user list status
    function checkUserListStatus() {
      console.log('[DIAGNOSTIC] Checking user list status...');
      
      const userListEl = document.getElementById('userList');
      if (!userListEl) {
        console.log('[DIAGNOSTIC] User list element not found!');
        return;
      }
      
      const userEntries = userListEl.querySelectorAll('.user-entry');
      console.log('[DIAGNOSTIC] Found', userEntries.length, 'user entries in DOM');
      
      if (userEntries.length === 0) {
        console.log('[DIAGNOSTIC] User list is empty! This needs to be fixed.');
        
        // Get the username from session storage
        const currentUsername = sessionStorage.getItem('userName');
        console.log('[DIAGNOSTIC] Current username from session:', currentUsername);
        
        if (currentUsername) {
          console.log('[DIAGNOSTIC] Attempting to create emergency user entry');
          
          // Create an emergency entry for the current user
          const userEntry = document.createElement('div');
          userEntry.classList.add('user-entry');
          userEntry.id = `user-emergency`;
          
          // Generate avatar background color
          const avatarColor = '#673ab7'; // Use purple as default
          
          userEntry.innerHTML = `
            <div class="avatar" style="background-color: ${avatarColor}">
              ${currentUsername.charAt(0).toUpperCase()}
            </div>
            <span class="username">${currentUsername}</span>
            <span class="vote-badge">?</span>
          `;
          
          userListEl.appendChild(userEntry);
          console.log('[DIAGNOSTIC] Emergency user entry added');
          
          // Also try to request user list again from server
          if (window.socket && window.socket.connected) {
            console.log('[DIAGNOSTIC] Requesting user list from server');
            window.socket.emit('requestUserList');
          }
        }
      }
    }
    
    // Run diagnostic check after loading
    setTimeout(checkUserListStatus, 3000);
    
    // Initialize on page load
    document.addEventListener('DOMContentLoaded', function() {
      // Check for stories
      checkForStories();
      
      // Setup reveal button click handler
      const revealBtn = document.getElementById('revealVotesBtn');
      if (revealBtn) {
        revealBtn.addEventListener('click', revealVotes);
      }
      
      // Setup invite button with direct handler to ensure it uses our custom modal
      const inviteBtn = document.getElementById('inviteButton');
      if (inviteBtn) {
        // Remove any existing handlers first by cloning and replacing
        const newInviteBtn = inviteBtn.cloneNode(true);
        inviteBtn.parentNode.replaceChild(newInviteBtn, inviteBtn);
        
        // Add our custom handler
        newInviteBtn.addEventListener('click', function(e) {
          e.preventDefault();
          e.stopPropagation();
          showInviteModalCustom();
        });
      }
      
      // Setup guest mode restrictions
      setupGuestModeOnLoad();
      
      // Hide original modals
      hideAllOriginalModals();
    });
  </script>
  <!-- The socket.js script should use getUserName() to get the username -->
  <script src="socket.js"></script>
  <script src="main.js"></script>
</body>
</html>
